{"version":3,"file":"index.js","sources":["../../src/main.ts"],"sourcesContent":["import os from 'os';\nimport { join } from 'path';\nimport { writeFile } from 'fs/promises';\n\nimport { exportVariable, getIDToken, getInput, setFailed, setOutput, setSecret } from '@actions/core';\nimport CredentialClient, {\n  Config,\n  RAMRoleARNCredentialsProvider,\n  EnvironmentVariableCredentialsProvider,\n} from '@alicloud/credentials';\n\ninterface Credential {\n  accessKeyId: string;\n  accessKeySecret: string;\n  securityToken: string;\n}\n\nconst ROLE_SESSION_NAME = getInput('role-session-name', { required: false });\nconst roleToAssume = getInput('role-to-assume', { required: false });\nconst oidcProviderArn = getInput('oidc-provider-arn');\nconst roleSessionExpiration = getInput('role-session-expiration', { required: false });\nconst roleChainingInput = getInput('role-chaining', { required: false });\nconst roleChaining = roleChainingInput === 'true';\n\nfunction setCredentialsOutput(accessKeyId: string, accessKeySecret: string, securityToken: string): void {\n  setSecret(accessKeyId);\n  setSecret(accessKeySecret);\n  setSecret(securityToken);\n  setOutput('aliyun-access-key-id', accessKeyId);\n  setOutput('aliyun-access-key-secret', accessKeySecret);\n  setOutput('aliyun-security-token', securityToken);\n  // use standard environment variables\n  exportVariable('ALIBABA_CLOUD_ACCESS_KEY_ID', accessKeyId);\n  exportVariable('ALIBABA_CLOUD_ACCESS_KEY_SECRET', accessKeySecret);\n  exportVariable('ALIBABA_CLOUD_SECURITY_TOKEN', securityToken);\n  exportVariable('ALICLOUD_ACCESS_KEY', accessKeyId);\n  exportVariable('ALICLOUD_SECRET_KEY', accessKeySecret);\n  exportVariable('ALICLOUD_SECURITY_TOKEN', securityToken);\n  // keep it for compatibility\n  exportVariable('ALIBABACLOUD_ACCESS_KEY_ID', accessKeyId);\n  exportVariable('ALIBABACLOUD_ACCESS_KEY_SECRET', accessKeySecret);\n  exportVariable('ALIBABACLOUD_SECURITY_TOKEN', securityToken);\n}\n\nexport async function run(): Promise<void> {\n  // Scenario 1: Role Chaining â€” use existing env credentials to assume another role\n  if (roleChaining) {\n    if (!roleToAssume) {\n      throw new Error(\"'role-to-assume' must be provided if 'role-chaining' is provided\");\n    }\n\n    const provider = RAMRoleARNCredentialsProvider.builder()\n      .withCredentialsProvider(EnvironmentVariableCredentialsProvider.builder().build())\n      .withRoleArn(roleToAssume)\n      .withRoleSessionName(ROLE_SESSION_NAME)\n      .withDurationSeconds(Number(roleSessionExpiration))\n      .build();\n\n    const cred = new CredentialClient(null, provider);\n    const { accessKeyId, accessKeySecret, securityToken } = (await cred.getCredential()) as Credential;\n    setCredentialsOutput(accessKeyId, accessKeySecret, securityToken);\n    return;\n  }\n\n  // Scenario 2: OIDC Role Assumption\n  if (roleToAssume && oidcProviderArn) {\n    const audience = getInput('audience');\n    const idToken = await getIDToken(audience);\n    const oidcTokenFilePath = join(os.tmpdir(), 'token');\n    // write into token file\n    await writeFile(oidcTokenFilePath, idToken);\n\n    const config = new Config({\n      type: 'oidc_role_arn',\n      roleArn: roleToAssume,\n      oidcProviderArn,\n      oidcTokenFilePath,\n      roleSessionExpiration: Number(roleSessionExpiration),\n      roleSessionName: ROLE_SESSION_NAME,\n    });\n    const client = new CredentialClient(config);\n    const { accessKeyId, accessKeySecret, securityToken } = (await client.getCredential()) as Credential;\n    setCredentialsOutput(accessKeyId, accessKeySecret, securityToken);\n    return;\n  }\n\n  // Scenario 3 & 4: ECS RAM Role (with or without role assumption)\n  const ecsConfig = new Config({ type: 'ecs_ram_role' });\n  const ecsClient = new CredentialClient(ecsConfig);\n  const {\n    accessKeyId: ecsKeyId,\n    accessKeySecret: ecsKeySecret,\n    securityToken: ecsToken,\n  } = (await ecsClient.getCredential()) as Credential;\n\n  if (roleToAssume) {\n    // Scenario 3: use ECS credentials to assume another role\n    const ramConfig = new Config({\n      type: 'ram_role_arn',\n      accessKeyId: ecsKeyId,\n      accessKeySecret: ecsKeySecret,\n      securityToken: ecsToken,\n      roleArn: roleToAssume,\n      roleSessionExpiration: Number(roleSessionExpiration),\n      roleSessionName: ROLE_SESSION_NAME,\n    });\n    const ramCred = new CredentialClient(ramConfig);\n    const { accessKeyId, accessKeySecret, securityToken } = (await ramCred.getCredential()) as Credential;\n    setCredentialsOutput(accessKeyId, accessKeySecret, securityToken);\n    return;\n  }\n\n  // Scenario 4: use ECS credentials directly\n  setCredentialsOutput(ecsKeyId, ecsKeySecret, ecsToken);\n}\n\nif (require.main === module) {\n  run().catch((err: Error) => {\n    console.log(err.stack);\n    setFailed(err.message);\n  });\n}\n"],"names":[],"mappings":"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"}